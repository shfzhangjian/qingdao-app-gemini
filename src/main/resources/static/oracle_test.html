<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle API 推送模拟器</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="libs/bootstrap-5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="libs/bootstrap-icons-1.11.3/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #003366;
            --light-gray: #f0f2f5;
            --text-color: #333;
            --border-color: #d9d9d9;
            --bg-color: #ffffff;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }
        html, body {
            height: 100%;
        }
        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--light-gray);
            color: var(--text-color);
            font-size: 14px;
            /* 允许容器 flex 布局占满高度 */
            display: flex;
            flex-direction: column;
        }
        /* [新] 调整 container 样式以支持 flex 和高度100% */
        .container {
            max-width: 900px;
            margin: 1.5rem auto;
            background-color: var(--bg-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            /* 核心: flex 布局 */
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            /* 限制高度防止溢出 */
            max-height: calc(100vh - 3rem);
        }
        .header {
            background-color: var(--secondary-color);
            color: white; padding: 12px 24px;
            font-size: 18px;
            font-weight: 500;
            border-radius: 8px 8px 0 0;
            flex-shrink: 0; /* 防止 header 缩小 */
        }
        .form-section {
            padding: 1.5rem;
        }
        /* [新] Tab 内容区域 flex 布局 */
        .tab-content {
            flex-grow: 1; /* 占据剩余空间 */
            min-height: 0; /* 允许内部元素滚动 */
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            border-top: 0;
            border-radius: 0 0 4px 4px;
        }
        .tab-pane {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .log-section {
            display: flex;
            flex-direction: column;
            height: 100%;
            flex-grow: 1;
        }
        textarea {
            width: 100%;
            flex-grow: 1; /* 占满日志tab的剩余空间 */
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
            box-sizing: border-box;
            background-color: #2b2b2b;
            color: #f2f2f2;
        }
        button { background-color: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; font-size: 14px; }
        button:hover { background-color: var(--secondary-color); }
        button:disabled { background-color: #a0a0a0; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        button.info { background-color: #0dcaf0; }
        button.info:hover { background-color: #0aa8c2; }
        .btn-group .btn {
            white-space: normal;
            word-wrap: break-word;
        }
        .nav-tabs .nav-link {
            color: var(--text-color);
        }
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            font-weight: bold;
        }

        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .toast { padding: 12px 20px; border-radius: 4px; color: white; font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); opacity: 0; transform: translateX(100%); animation: slideIn 0.3s forwards; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #0d6efd; }
        .toast.fade-out { animation: slideOut 0.3s forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    </style>
</head>
<body>

<div class="container">
    <header class="header">Oracle API 推送模拟器</header>

    <!-- [新] Tab 导航 -->
    <ul class="nav nav-tabs" id="myTab" role="tablist" style="padding: 0 1.5rem; border-bottom: 1px solid var(--border-color);">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="panel-tab-btn" data-bs-toggle="tab" data-bs-target="#panel-tab" type="button" role="tab" aria-controls="panel-tab" aria-selected="true">
                <i class="bi bi-play-circle-fill me-1"></i> 按钮面板
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="log-tab-btn" data-bs-toggle="tab" data-bs-target="#log-tab" type="button" role="tab" aria-controls="log-tab" aria-selected="false">
                <i class="bi bi-terminal-fill me-1"></i> 响应日志
            </button>
        </li>
    </ul>

    <!-- [新] Tab 内容 -->
    <div class="tab-content" id="myTabContent">
        <!-- (1) 按钮面板 Tab -->
        <div class="tab-pane fade show active" id="panel-tab" role="tabpanel" aria-labelledby="panel-tab-btn">
            <div class="form-section" id="api-button-container">
                <h5>(1) 模拟Oracle触发推送 (stype)</h5>

                <label class="form-label mt-3">接口 1: 推送保养任务 (高并发, 无参数)</label>
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-primary" data-stype="SP_GENDAYTASK">SP_GENDAYTASK (日保)</button>
                    <button type="button" class="btn btn-primary" data-stype="PMBOARD.SP_QD_PLANBOARD_LB">SP_QD_PLANBOARD_LB (轮保/月保)</button>
                    <button type="button" class="btn btn-primary" data-stype="JOB_GEN_BAOYANG_TASKS">JOB_GEN_BAOYANG_TASKS (例保)</button>
                </div>

                <label class="form-label mt-3">其他推送 (无参数)</label>
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-secondary" data-stype="TIMS_PUSH_ROTATIONAL_TASK">接口 7: TIMS_PUSH_ROTATIONAL_TASK (轮保任务)</button>
                    <button type="button" class="btn btn-secondary" data-stype="PD_ZY_JM">(旧) PD_ZY_JM (专业/精密点检)</button>
                </div>

                <label class="form-label mt-3">带参数的推送 (低并发)</label>
                <div class="input-group mb-2">
                    <button class="btn btn-outline-primary" type="button" data-stype-prefix="EQ_PLANLB_ARCHIVED" data-param-input="param-eq-planlb">接口 5: EQ_PLANLB_ARCHIVED</button>
                    <input type="text" class="form-control" placeholder="输入 ID (例如: 123456)" id="param-eq-planlb" value="123456">
                </div>
                <div class="input-group mb-2">
                    <button class="btn btn-outline-primary" type="button" data-stype-prefix="TIMS_PUSH_FAULT_REPORT_CODE" data-param-input="param-fault-code">接口 12: TIMS_PUSH_FAULT_REPORT_CODE</button>
                    <input type="text" class="form-control" placeholder="输入 ID (例如: 101)" id="param-fault-code" value="101">
                </div>
                <div class="input-group">
                    <button class="btn btn-outline-primary" type="button" data-stype-prefix="PM_MONTH_ARCHIVED" data-param-input="param-pm-month">接口 13: PM_MONTH_ARCHIVED</button>
                    <input type="text" class="form-control" placeholder="输入 ID (例如: 5678)" id="param-pm-month" value="5678">
                </div>

                <hr class="my-4">

                <h5>(2) 手动/调试操作</h5>
                <div class="d-grid gap-2">
                    <button id="push-all-bao-ji-btn" class="btn btn-info"><i class="bi bi-person-badge"></i> 手动推送所有包机信息</button>
                    <button id="clear-cache-btn" class="btn btn-danger"><i class="bi bi-eraser-fill"></i> 清空Redis缓存 (用于调试)</button>
                </div>
            </div>
        </div>

        <!-- (2) 响应日志 Tab -->
        <div class="tab-pane fade" id="log-tab" role="tabpanel" aria-labelledby="log-tab-btn">
            <div class="log-section">
                <div class="d-flex justify-content-end align-items-center mb-2">
                    <button id="clear-log-btn" class="btn btn-sm secondary"><i class="bi bi-trash"></i> 清空日志</button>
                </div>
                <textarea id="response-log" readonly></textarea>
            </div>
        </div>
    </div>
</div>

<div id="toast-container" class="toast-container"></div>

<!-- [新] 引入 Bootstrap JS (Tab功能需要) -->
<script src="libs/bootstrap-5.3.3/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const apiButtonContainer = document.getElementById('api-button-container');
        const clearLogBtn = document.getElementById('clear-log-btn');
        const logArea = document.getElementById('response-log');

        if (clearLogBtn) {
            clearLogBtn.addEventListener('click', function() { logArea.value = ''; });
        }

        // [新] 使用事件委托处理所有API按钮的点击
        if (apiButtonContainer) {
            apiButtonContainer.addEventListener('click', async function(e) {
                const button = e.target.closest('button');
                if (!button) return;

                let stype = button.dataset.stype;
                let stypePrefix = button.dataset.stypePrefix;
                let paramInputId = button.dataset.paramInput;

                let finalStype = null;
                let originalButtonHtml = button.innerHTML;
                let apiPayload = null;
                let apiUrl = null;
                let fetchOptions = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                };

                if (stype) {
                    // --- (1a) 无参数stype按钮 ---
                    finalStype = stype;
                    apiPayload = { stype: finalStype };
                    apiUrl = 'api/oracle/receive';
                    fetchOptions.body = JSON.stringify(apiPayload);

                } else if (stypePrefix && paramInputId) {
                    // --- (1b) 带参数stype按钮 ---
                    const paramInput = document.getElementById(paramInputId);
                    const paramValue = paramInput ? paramInput.value.trim() : '';
                    if (!paramValue) {
                        showToast(`请输入 ID`, 'error');
                        return;
                    }
                    finalStype = `${stypePrefix}:${paramValue}`;
                    apiPayload = { stype: finalStype };
                    apiUrl = 'api/oracle/receive';
                    fetchOptions.body = JSON.stringify(apiPayload);

                } else if (button.id === 'push-all-bao-ji-btn') {
                    // --- (2) 手动推送包机 ---
                    if (!confirm('确定要查询所有包机信息并推送到Kafka吗？\n这将推送全量数据。')) return;
                    apiUrl = 'api/push/user-equipment-all';

                } else if (button.id === 'clear-cache-btn') {
                    // --- (3) 清空缓存 ---
                    if (!confirm('确定要清空所有 Oracle 推送任务的 Redis 缓存吗？\n这将允许所有任务被重新推送。')) return;
                    apiUrl = 'api/oracle/clear-push-cache';

                } else {
                    // 不是我们关心的按钮
                    return;
                }

                // --- 执行API请求 ---
                await handleApiRequest(
                    apiUrl,
                    fetchOptions,
                    button,
                    originalButtonHtml
                );
            });
        }

        // --- 辅助函数 ---

        /**
         * 通用的API请求处理函数
         */
        async function handleApiRequest(url, options, button, originalButtonHtml) {
            const btnText = button.textContent;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 处理中...';

            const logPayload = options.body ? `\nPayload: ${options.body}` : '';
            logToArea(`---> [${new Date().toLocaleTimeString()}] 发起请求: ${options.method || 'GET'} ${url}${logPayload}\n`);

            try {
                const response = await fetch(url, options);
                const responseData = await response.json();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(responseData)}`);
                }

                // 打印收到的第一条响应
                logToArea(`<--- [${new Date().toLocaleTimeString()}] 收到响应 (HTTP ${response.status}):\n${JSON.stringify(responseData, null, 2)}\n\n`);

                // 检查是否是异步任务
                if (responseData.taskId && responseData.status && responseData.status.startsWith('Task submitted')) {
                    // 是异步任务，开始轮询
                    showToast(`任务已提交 (ID: ${responseData.taskId})，正在后台处理...`, 'info');
                    pollTaskStatus(responseData.taskId); // <-- [新] 开始轮询
                } else {
                    // 是同步任务，直接显示成功
                    showToast(`${btnText} 操作成功`, 'success');
                }

            } catch (error) {
                logToArea(`<--- [${new Date().toLocaleTimeString()}] 请求失败:\n${error.message}\n\n`);
                showToast(`${btnText} 操作失败: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalButtonHtml;
            }
        }

        /**
         * 轮询任务状态函数
         * @param {string} taskId - 要查询的任务ID
         */
        function pollTaskStatus(taskId) {
            let pollCount = 0;
            const maxPolls = 30; // 最多轮询30秒

            logToArea(`---> [${new Date().toLocaleTimeString()}] 开始轮询任务状态: ${taskId}\n`);

            const intervalId = setInterval(async () => {
                pollCount++;
                if (pollCount > maxPolls) {
                    clearInterval(intervalId);
                    logToArea(`!!!! [${new Date().toLocaleTimeString()}] 任务 ${taskId} 轮询超时 (30s)。\n`);
                    showToast(`任务 ${taskId} 轮询超时`, 'error');
                    return;
                }

                try {
                    const response = await fetch(`api/oracle/task-status/${taskId}`);
                    const data = await response.json();

                    if (!response.ok) {
                        // 404 Not Found 也算是一种状态
                        logToArea(`.... [${new Date().toLocaleTimeString()}] 状态查询: ${data.status || 'NOT_FOUND'}\n`);
                        clearInterval(intervalId);
                        showToast(`任务 ${taskId} 未找到`, 'error');
                        return;
                    }

                    const status = data.status;
                    logToArea(`.... [${new Date().toLocaleTimeString()}] 状态: ${status}\n`);

                    // 检查是否为最终状态
                    if (status.startsWith('SUCCESS') || status.startsWith('FAILED') || status.startsWith('SKIPPED')) {
                        clearInterval(intervalId);
                        logToArea(`---- [${new Date().toLocaleTimeString()}] 任务 ${taskId} 轮询结束。\n\n`);
                        if (status.startsWith('SUCCESS')) {
                            showToast(`任务 ${taskId} 处理成功: ${status}`, 'success');
                        } else {
                            showToast(`任务 ${taskId} 完成: ${status}`, 'info');
                        }
                    }
                    // 如果是 PENDING 或 RUNNING，则不打印日志，继续轮询

                } catch (error) {
                    clearInterval(intervalId);
                    logToArea(`!!!! [${new Date().toLocaleTimeString()}] 轮询 ${taskId} 时出错: ${error.message}\n\n`);
                    showToast(`轮询任务 ${taskId} 失败`, 'error');
                }
            }, 1000); // 每秒轮询一次
        }


        function logToArea(message) {
            logArea.value += message;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('fade-out');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }
    });
</script>

</body>
</html>