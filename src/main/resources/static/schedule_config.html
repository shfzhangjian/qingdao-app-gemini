<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>动态定时任务配置</title>
    <link href="libs/bootstrap-5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="libs/bootstrap-icons-1.11.3/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .card-header {
            background-color: #003366;
            color: white;
        }
        .cron-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .cron-item .form-select {
            flex: 1 1 80px; /* 允许下拉框缩小 */
            min-width: 80px;
        }
        .cron-item .btn {
            flex-shrink: 0;
        }
        .cron-labels {
            display: grid;
            grid-template-columns: 90px 90px 90px 90px 90px 1fr;
            gap: 10px;
            padding: 0 10px 0 50px; /* 对齐输入框 */
            font-size: 0.75rem;
            font-weight: bold;
            color: #6c757d;
            margin-bottom: 5px;
        }
        .task-section {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: white;
        }
        .task-section h5 {
            margin-bottom: 1rem;
            color: #003366;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card shadow-sm">
        <div class="card-header">
            <h4 class="mb-0"><i class="bi bi-clock-history"></i> 动态定时任务配置</h4>
        </div>
        <div class="card-body bg-light">
            <p class="card-text text-muted mb-4">
                管理系统各项后台任务的执行时间。
                <br>
                Cron 格式: `秒(0) 分 时 日 月 周` (例如: `0 0 1 * * ?` 表示每天凌晨1点)
            </p>

            <div id="loading-spinner" class="text-center my-3 d-none">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>正在加载配置...</p>
            </div>

            <div id="error-alert" class="alert alert-danger d-none" role="alert"></div>

            <div id="config-form" class="d-none">

                <!-- 任务 1: 包机信息推送 -->
                <div class="task-section">
                    <h5><i class="bi bi-person-badge me-2"></i>1. 每日包机信息推送</h5>
                    <p class="small text-muted">对应接口: <code>tims.sync.user.equipment</code></p>

                    <div class="cron-labels d-none" id="cron-labels-1">
                        <span>分 (0-59)</span>
                        <span>时 (0-23)</span>
                        <span>日 (*)</span>
                        <span>月 (*)</span>
                        <span>周 (?)</span>
                    </div>
                    <div id="cron-list-1" class="mb-3">
                        <!-- Cron items will be injected here -->
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="createCronInput('cron-list-1', '0 0 1 * * ?')">
                        <i class="bi bi-plus-lg"></i> 添加时间点
                    </button>
                </div>

                <!-- 任务 2: 轮保任务生成与推送 -->
                <div class="task-section">
                    <h5><i class="bi bi-arrow-repeat me-2"></i>2. 轮保任务生成与推送</h5>
                    <p class="small text-muted">对应过程: <code>tmis.genlb</code> -> 视图 <code>view_lb_task</code></p>

                    <div class="cron-labels d-none" id="cron-labels-2">
                        <span>分 (0-59)</span>
                        <span>时 (0-23)</span>
                        <span>日 (*)</span>
                        <span>月 (*)</span>
                        <span>周 (?)</span>
                    </div>
                    <div id="cron-list-2" class="mb-3">
                        <!-- Cron items will be injected here -->
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="createCronInput('cron-list-2', '0 30 6 * * ?')">
                        <i class="bi bi-plus-lg"></i> 添加时间点
                    </button>
                </div>

                <hr>

                <button id="save-btn" class="btn btn-primary w-100 btn-lg" disabled>
                    <i class="bi bi-save-fill"></i> 保存并重载所有任务
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast 容器 -->
<div class="toast-container"></div>

<script src="libs/bootstrap-5.3.3/js/bootstrap.bundle.min.js"></script>
<script>
    // 将 createCronInput 暴露到全局作用域以便 HTML onclick 调用
    window.createCronInput = null;

    document.addEventListener('DOMContentLoaded', function () {
        const saveBtn = document.getElementById('save-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorAlert = document.getElementById('error-alert');
        const configForm = document.getElementById('config-form');
        const toastContainer = document.querySelector('.toast-container');

        const API_URL = '/tmis/api/schedule/config';

        /**
         * 获取 JWT Token
         */
        function getToken() {
            let token = localStorage.getItem('jwt_token');
            if (!token) {
                token = localStorage.getItem('authToken');
            }
            return token;
        }

        /**
         * 显示 Toast 提示
         */
        function showToast(title, message, type = 'success') {
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}</strong><br>${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);

            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
            toast.show();
            toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
        }

        /**
         * 显示错误提示
         */
        function showError(message) {
            errorAlert.textContent = message;
            errorAlert.classList.remove('d-none');
            loadingSpinner.classList.add('d-none');
            configForm.classList.add('d-none');
            saveBtn.disabled = true;
        }

        /**
         * [重构] 创建 Cron 表达式的下拉选择行
         * @param {string} containerId - 容器ID
         * @param {string} cronValue - 初始Cron值
         */
        window.createCronInput = function(containerId, cronValue = '0 0 1 * * ?') {
            const container = document.getElementById(containerId);
            const labelsId = containerId.replace('list', 'labels'); // e.g. cron-labels-1
            const labels = document.getElementById(labelsId);

            const parts = parseCron(cronValue);

            const div = document.createElement('div');
            div.className = 'cron-item input-group input-group-sm';

            div.innerHTML = `
                <!-- 0. 秒 (固定为 0) -->
                <input type="hidden" data-cronpart="second" value="0">

                <!-- 1. 分钟 -->
                <select class="form-select" data-cronpart="minute">
                    ${createOptions(0, 59, parts.minute)}
                </select>

                <!-- 2. 小时 -->
                <select class="form-select" data-cronpart="hour">
                    ${createOptions(0, 23, parts.hour)}
                </select>

                <!-- 3. 日 -->
                <select class="form-select" data-cronpart="dayOfMonth">
                    <option value="*" ${parts.dayOfMonth === '*' ? 'selected' : ''}>* (每日)</option>
                    ${createOptions(1, 31, parts.dayOfMonth)}
                </select>

                <!-- 4. 月 -->
                <select class="form-select" data-cronpart="month">
                    <option value="*" ${parts.month === '*' ? 'selected' : ''}>* (每月)</option>
                    ${createOptions(1, 12, parts.month)}
                </select>

                <!-- 5. 周 -->
                <select class="form-select" data-cronpart="dayOfWeek">
                    <option value="?" ${parts.dayOfWeek === '?' ? 'selected' : ''}>? (任意)</option>
                    <option value="*" ${parts.dayOfWeek === '*' ? 'selected' : ''}>* (每日)</option>
                    <option value="1" ${parts.dayOfWeek === '1' ? 'selected' : ''}>1 (周日)</option>
                    <option value="2" ${parts.dayOfWeek === '2' ? 'selected' : ''}>2 (周一)</option>
                    <option value="3" ${parts.dayOfWeek === '3' ? 'selected' : ''}>3 (周二)</option>
                    <option value="4" ${parts.dayOfWeek === '4' ? 'selected' : ''}>4 (周三)</option>
                    <option value="5" ${parts.dayOfWeek === '5' ? 'selected' : ''}>5 (周四)</option>
                    <option value="6" ${parts.dayOfWeek === '6' ? 'selected' : ''}>6 (周五)</option>
                    <option value="7" ${parts.dayOfWeek === '7' ? 'selected' : ''}>7 (周六)</option>
                </select>

                <button class="btn btn-outline-danger" type="button" data-action="delete">
                    <i class="bi bi-trash-fill"></i>
                </button>
            `;

            div.querySelector('[data-action="delete"]').addEventListener('click', () => {
                div.remove();
                if (container.children.length === 0) {
                    labels.classList.add('d-none');
                }
            });

            container.appendChild(div);
            labels.classList.remove('d-none');
        };

        function createOptions(start, end, selectedValue) {
            let html = '';
            for (let i = start; i <= end; i++) {
                html += `<option value="${i}" ${String(i) === selectedValue ? 'selected' : ''}>${i}</option>`;
            }
            return html;
        }

        function parseCron(cronString = '0 0 1 * * ?') {
            const parts = cronString.split(' ');
            return {
                second: parts[0] || '0',
                minute: parts[1] || '0',
                hour: parts[2] || '1',
                dayOfMonth: parts[3] || '*',
                month: parts[4] || '*',
                dayOfWeek: parts[5] || '?'
            };
        }

        function buildCron(cronItemElement) {
            const second = '0';
            const minute = cronItemElement.querySelector('[data-cronpart="minute"]').value;
            const hour = cronItemElement.querySelector('[data-cronpart="hour"]').value;
            const dayOfMonth = cronItemElement.querySelector('[data-cronpart="dayOfMonth"]').value;
            const month = cronItemElement.querySelector('[data-cronpart="month"]').value;
            const dayOfWeek = cronItemElement.querySelector('[data-cronpart="dayOfWeek"]').value;
            return `${second} ${minute} ${hour} ${dayOfMonth} ${month} ${dayOfWeek}`;
        }

        function getCronsFromContainer(containerId) {
            const container = document.getElementById(containerId);
            const items = container.querySelectorAll('.cron-item');
            return Array.from(items)
                .map(itemElement => buildCron(itemElement).trim())
                .filter(cron => cron.length > 0);
        }

        async function loadConfig() {
            loadingSpinner.classList.remove('d-none');
            errorAlert.classList.add('d-none');
            configForm.classList.add('d-none');
            saveBtn.disabled = true;

            const token = getToken();
            if (!token) {
                showError('未找到认证Token。请先登录主系统。');
                return;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status} 错误`);
                }

                const config = await response.json();

                // 清空旧数据
                document.getElementById('cron-list-1').innerHTML = '';
                document.getElementById('cron-list-2').innerHTML = '';

                // 加载 任务1: 包机推送 (cronExpressions)
                if (config.cronExpressions && config.cronExpressions.length > 0) {
                    config.cronExpressions.forEach(cron => createCronInput('cron-list-1', cron));
                } else {
                    createCronInput('cron-list-1', '0 0 1 * * ?');
                }

                // 加载 任务2: 轮保推送 (lbTaskCronExpressions)
                if (config.lbTaskCronExpressions && config.lbTaskCronExpressions.length > 0) {
                    config.lbTaskCronExpressions.forEach(cron => createCronInput('cron-list-2', cron));
                } else {
                    createCronInput('cron-list-2', '0 30 6 * * ?');
                }

                configForm.classList.remove('d-none');
                saveBtn.disabled = false;

            } catch (error) {
                showError(`加载配置失败: ${error.message}`);
            } finally {
                loadingSpinner.classList.add('d-none');
            }
        }

        async function saveConfig() {
            const token = getToken();
            if (!token) {
                showToast('保存失败', '未找到认证Token，请重新登录。', 'danger');
                return;
            }

            // 收集所有 Cron
            const cronList1 = getCronsFromContainer('cron-list-1');
            const cronList2 = getCronsFromContainer('cron-list-2');

            // 确保至少有一个默认值，防止保存为空导致后端报错或逻辑问题
            if (cronList1.length === 0) cronList1.push("0 0 1 * * ?");
            if (cronList2.length === 0) cronList2.push("0 30 6 * * ?");

            const payload = {
                cronExpressions: cronList1,
                lbTaskCronExpressions: cronList2
            };

            const originalBtnHtml = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 正在保存并重载...';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('保存成功', '所有定时任务配置已更新并重新加载。', 'success');
                    await loadConfig(); // 刷新界面
                } else {
                    throw new Error(result.error || '未知错误');
                }

            } catch (error) {
                showToast('保存失败', error.message, 'danger');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalBtnHtml;
            }
        }

        saveBtn.addEventListener('click', saveConfig);

        // 初始加载
        loadConfig();
    });
</script>

</body>
</html>