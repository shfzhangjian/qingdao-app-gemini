<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>青岛卷烟厂 TsPM - TMIS 信息集成日志监控</title>
    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #003366;
            --light-gray: #f0f2f5;
            --text-color: #333;
            --border-color: #d9d9d9;
            --bg-color: #ffffff;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }
        body { margin: 0; font-family: var(--font-family); background-color: var(--light-gray); color: var(--text-color); font-size: 14px; }
        .container { display: flex; flex-direction: column; height: 100vh; }
        .header { background-color: var(--secondary-color); color: white; padding: 12px 24px; font-size: 18px; font-weight: 500; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 10; }
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .nav-sidebar { background-color: var(--bg-color); width: 240px; border-right: 1px solid var(--border-color); padding: 8px 0; overflow-y: auto; flex-shrink: 0; }
        .nav-item { display: block; padding: 10px 20px; color: var(--text-color); text-decoration: none; border-left: 3px solid transparent; transition: all 0.2s; font-size: 13px; }
        .nav-item:hover { background-color: var(--light-gray); color: var(--primary-color); }
        .nav-item.active { background-color: #e6f7ff; border-left-color: var(--primary-color); color: var(--primary-color); font-weight: 600; }
        .nav-group-title { padding: 15px 20px 5px; font-size: 12px; font-weight: bold; color: #888; text-transform: uppercase; }
        .content-area { flex: 1; padding: 16px; display: flex; flex-direction: column; overflow: hidden; }
        .tab-content { display: none; height: 100%; flex-direction: column; }
        .tab-content.active { display: flex; }
        .content-header { padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .content-header h2 { margin: 0; font-size: 16px; }
        .content-body { flex: 1; display: flex; flex-direction: column; gap: 16px; min-height: 0; }
        textarea { width: 100%; flex-grow: 1; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px; font-family: 'Courier New', Courier, monospace; font-size: 13px; line-height: 1.5; resize: none; box-sizing: border-box; }
        .sql-section, .json-section { display: flex; flex-direction: column; min-height: 0; flex-basis: 50%; }
        .section-header { margin: 0 0 8px 0; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .file-ops button { font-size: 12px; padding: 4px 10px; background-color: #6c757d; }
        .file-ops button:hover { background-color: #5a6268; }
        .sql-controls { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
        .sql-controls label { font-size: 13px; }
        .sql-controls input[type="number"] { width: 60px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; }
        /* New styles for parameter section */
        .sql-params-section { display: flex; flex-direction: column; margin-top: 10px; }
        .sql-params-section label { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
        #sql-params { height: 60px; resize: vertical; flex-grow: 0; }

        button { background-color: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; font-size: 14px; }
        button:hover { background-color: var(--secondary-color); }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }
        #log-tab-content, .receiver-tab-content { height: 100%; display: flex; flex-direction: column; }
        .controls-bar { display: flex; gap: 10px; align-items: center; padding-bottom: 12px; flex-shrink: 0; }
        .controls-bar input[type="text"], .controls-bar select { padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px; }
        .controls-bar label { display: flex; align-items: center; gap: 4px; cursor: pointer; }
        #logContainer { flex: 1; background-color: #2b2b2b; color: #f2f2f2; padding: 12px; border-radius: 4px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 13px; line-height: 1.6; }
        .log-entry { padding: 8px 0; border-bottom: 1px solid #444; }
        .log-entry:last-child { border-bottom: none; }
        .log-timestamp { color: #888; margin-right: 10px; }
        .log-type-PUSH, .log-type-PUSH_ERROR, .log-type-RECEIVE, .log-type-RECEIVE_ERROR { font-weight: bold; }
        .log-type-PUSH { color: #87cefa; }
        .log-type-PUSH_ERROR { color: #f08080; }
        .log-type-RECEIVE { color: #98fb98; }
        .log-type-RECEIVE_ERROR { color: #ff4500; }
        .log-topic { color: #ffd700; }
        .log-content { margin-top: 6px; padding: 10px; background-color: #333; border-radius: 4px; }
        .log-content pre { margin: 0; white-space: pre-wrap; word-break: break-all; color: #ccc; }

        .table-container { flex: 1; overflow: auto; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--bg-color); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 13px; }
        thead { background-color: #fafafa; position: sticky; top: 0; z-index: 1; }
        th { font-weight: 600; }
        tbody tr:hover { background-color: #f5f5f5; }
        .empty-data { text-align: center; padding: 40px; color: #888; }

        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 4px; color: white; font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); opacity: 0; transform: translateX(100%); animation: slideIn 0.3s forwards; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.fade-out { animation: slideOut 0.3s forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    </style>
    <script src="/sockjs.min.js"></script>
    <script src="/stomp.min.js"></script>
</head>
<body>

<div class="container">
    <header class="header">青岛卷烟厂 TsPM - TMIS 信息集成日志监控</header>
    <main class="main-content">
        <nav class="nav-sidebar" id="nav-sidebar"></nav>
        <div class="content-area" id="content-area"></div>
    </main>
</div>
<div id="toast-container" class="toast-container"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const producerTabs = [
            { id: 'syncMaintenanceTask', title: '接口 1: 推送保养任务', topic: 'tims.sync.maintenance.task' },
            { id: 'syncRotationalPlan', title: '接口 5: 推送轮保计划', topic: 'tims.sync.rotational.plan' },
            { id: 'syncRotationalTask', title: '接口 7: 推送轮保任务', topic: 'tims.sync.rotational.task' },
            { id: 'receiveFaultReportCode', title: '接口 12: 推送故障报告编码', topic: 'tims.receive.fault.report.code' },
            { id: 'syncProductionHaltTask', title: '接口 13: 推送停产检修任务', topic: 'tims.sync.production.halt.maintenance.task' },
            { id: 'syncUserEquipment', title: '接口 15: 推送包机信息', topic: 'tims.sync.user.equipment' }
        ];

        const receiverTabs = [
            { id: 'receiveTaskCompletion', title: '接口 2: 接收任务完成情况', topic: 'tims.feedback.completed.maintenance.task'},
            { id: 'receiveTaskScore', title: '接口 3: 接收任务得分', topic: 'tims.feedback.maintenance.task.score'},
            { id: 'receiveFaultReport', title: '接口 4/10: 接收故障报告', topic: 'tims.create.fault.report'},
            { id: 'receiveRecommendedTask', title: '接口 6: 接收推荐任务', topic: 'tims.recommend.rotational.task'},
            { id: 'receiveRotationalCompletion', title: '接口 8: 接收轮保完成', topic: 'tims.feedback.completed.rotational.task'},
            { id: 'receiveRotationalScore', title: '接口 9: 接收轮保得分', topic: 'tims.feedback.rotational.task.score'},
            { id: 'receiveFaultAnalysis', title: '接口 11: 接收故障分析', topic: 'tims.create.fault.analysis.report'},
            { id: 'receiveHaltCompletion', title: '接口 14: 接收停产检修完成', topic: 'tims.feedback.completed.production.halt.maintenance.task'}
        ];

        const logTab = { id: 'logMonitor', title: '日志监控', topic: 'N/A' };

        const topicDescriptions = {
            'tims.sync.maintenance.task': '接口 1: 推送保养、点检、润滑任务',
            'tims.feedback.completed.maintenance.task': '接口 2: 反馈任务完成情况',
            'tims.feedback.maintenance.task.score': '接口 3: 反馈任务完成得分',
            'tims.create.fault.report': '接口 4/10: 点检异常/故障报告',
            'tims.sync.rotational.plan': '接口 5: 推送轮保计划排期',
            'tims.recommend.rotational.task': '接口 6: 推荐轮保任务',
            'tims.sync.rotational.task': '接口 7: 推送筛选后轮保任务',
            'tims.feedback.completed.rotational.task': '接口 8: 反馈轮保完成情况',
            'tims.feedback.rotational.task.score': '接口 9: 反馈轮保完成得分',
            'tims.create.fault.analysis.report': '接口 11: 故障分析报告',
            'tims.receive.fault.report.code': '接口 12: 推送故障报告编码',
            'tims.sync.production.halt.maintenance.task': '接口 13: 推送停产检修任务',
            'tims.feedback.completed.production.halt.maintenance.task': '接口 14: 反馈停产检修完成',
            'tims.sync.user.equipment': '接口 15: 推送包机信息'
        };
        const allTopics = Object.keys(topicDescriptions).sort();

        const navSidebar = document.getElementById('nav-sidebar');
        const contentArea = document.getElementById('content-area');

        let allLogs = [];
        const maxLogs = 200;

        // --- UI Initialization ---

        function createNavItem(tab) {
            const navItem = document.createElement('a');
            navItem.id = `nav-${tab.id}`;
            navItem.href = '#';
            navItem.className = 'nav-item';
            navItem.textContent = tab.title;
            navItem.dataset.tabId = tab.id;
            navItem.dataset.topic = tab.topic;
            return navItem;
        }

        function createTabContent(tab, type) {
            const tabContent = document.createElement('div');
            tabContent.id = tab.id;
            tabContent.className = 'tab-content';
            contentArea.appendChild(tabContent);

            if (type === 'producer') {
                tabContent.innerHTML = `
                    <div class="content-header"><h2>${tab.title}</h2><button class="push-button" data-type="${tab.id}">推送消息</button></div>
                    <div class="content-body">
                        <div class="sql-section">
                            <div class="section-header"><h3>1. 从数据库生成模拟数据</h3><div class="file-ops"><button class="load-sql-button" data-type="${tab.id}">加载SQL</button><button class="save-sql-button" data-type="${tab.id}">保存SQL</button></div></div>
                            <textarea id="sql-${tab.id}" placeholder="在此输入SQL查询，使用 ? 作为参数占位符..."></textarea>
                            <div class="sql-params-section">
                                <label for="sql-params-${tab.id}">查询参数 (每行一个):</label>
                                <textarea id="sql-params-${tab.id}" class="sql-params" placeholder="例如:\nvalue1\n123\n2025-09-24"></textarea>
                            </div>
                            <div class="sql-controls">
                                <label for="limit-${tab.id}">查询行数:</label><input type="number" id="limit-${tab.id}" value="5" min="1" max="100">
                                <button class="generate-button secondary" data-type="${tab.id}">从SQL生成JSON</button>
                            </div>
                        </div>
                        <div class="json-section">
                            <div class="section-header"><h3>2. 检查并推送JSON内容</h3><div class="file-ops"><button class="load-json-button" data-type="${tab.id}">加载JSON</button><button class="save-json-button" data-type="${tab.id}">保存JSON</button></div></div>
                            <textarea id="json-${tab.id}"></textarea>
                        </div>
                    </div>`;
            } else if (type === 'receiver') {
                tabContent.innerHTML = `
                    <div class="content-header"><h2>${tab.title}</h2><button class="refresh-table-button" data-topic="${tab.topic}">刷新</button></div>
                    <div class="table-container" id="table-container-${tab.id}"><div class="empty-data">暂无数据，请等待消息接收或点击刷新。</div></div>`;
            } else { // Log monitor
                tabContent.innerHTML = `
                    <div class="controls-bar"><select id="logTopicFilter"><option value="all">所有主题</option></select><input type="text" id="logFilterInput" placeholder="按内容过滤..."><label><input type="checkbox" id="autoScroll" checked> 自动滚动</label><button id="clearLogBtn">清空日志</button></div>
                    <div id="logContainer"></div>`;
            }
        }

        // Build Navigation and Content Panes
        const producerTitle = document.createElement('div');
        producerTitle.className = 'nav-group-title';
        producerTitle.textContent = '推送接口 (TsPM -> TIMS)';
        navSidebar.appendChild(producerTitle);
        producerTabs.forEach(tab => {
            navSidebar.appendChild(createNavItem(tab));
            createTabContent(tab, 'producer');
        });

        const receiverTitle = document.createElement('div');
        receiverTitle.className = 'nav-group-title';
        receiverTitle.textContent = '接收接口 (TIMS -> TsPM)';
        navSidebar.appendChild(receiverTitle);
        receiverTabs.forEach(tab => {
            navSidebar.appendChild(createNavItem(tab));
            createTabContent(tab, 'receiver');
        });

        const monitorTitle = document.createElement('div');
        monitorTitle.className = 'nav-group-title';
        monitorTitle.textContent = '监控';
        navSidebar.appendChild(monitorTitle);
        navSidebar.appendChild(createNavItem(logTab));
        createTabContent(logTab, 'log');

        const topicFilterSelect = document.getElementById('logTopicFilter');
        allTopics.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic;
            option.textContent = `${topicDescriptions[topic] || '未知主题'} (${topic})`;
            topicFilterSelect.appendChild(option);
        });

        document.querySelector('.nav-item').classList.add('active');
        document.querySelector('.tab-content').classList.add('active');

        // --- Event Listeners ---
        document.body.addEventListener('click', function(e) {
            const target = e.target;
            const type = target.dataset.type;
            const topic = target.dataset.topic;

            if (target.matches('.nav-item')) {
                e.preventDefault();
                const tabId = target.dataset.tabId;
                document.querySelectorAll('.nav-item, .tab-content').forEach(el => el.classList.remove('active'));
                target.classList.add('active');
                document.getElementById(tabId).classList.add('active');
                if (receiverTabs.some(t => t.id === tabId)) {
                    if(topic !== 'N/A') fetchAndRenderTable(topic, `table-container-${tabId}`);
                }
            } else if (target.matches('.push-button')) {
                e.preventDefault();
                const textarea = document.getElementById(`json-${type}`);
                const dataStr = textarea.value.trim();
                if (!dataStr) { alert('推送内容不能为空！'); return; }
                try { pushMessage(type, JSON.parse(dataStr)); }
                catch (error) { showToast('JSON格式错误: ' + error.message, 'error'); }
            } else if (target.matches('.generate-button')) {
                e.preventDefault();
                generateJsonFromSql(type);
            } else if (target.matches('#clearLogBtn')) {
                e.preventDefault();
                allLogs = [];
                renderLogs();
            } else if (target.matches('.save-sql-button')) {
                e.preventDefault();
                saveToFile(document.getElementById(`sql-${type}`).value, `${type}-query.sql`, 'text/plain');
            } else if (target.matches('.load-sql-button')) {
                e.preventDefault();
                loadFromFile(document.getElementById(`sql-${type}`));
            } else if (target.matches('.save-json-button')) {
                e.preventDefault();
                saveToFile(document.getElementById(`json-${type}`).value, `${type}-data.json`, 'application/json');
            } else if (target.matches('.load-json-button')) {
                e.preventDefault();
                loadFromFile(document.getElementById(`json-${type}`));
            } else if (target.matches('.refresh-table-button')) {
                e.preventDefault();
                const tabId = document.querySelector('.nav-item.active').dataset.tabId;
                fetchAndRenderTable(topic, `table-container-${tabId}`);
            }
        });

        const logTabContent = document.getElementById('logMonitor');
        if(logTabContent) {
            logTabContent.addEventListener('input', e => { if (e.target.matches('#logFilterInput')) renderLogs(); });
            logTabContent.addEventListener('change', e => { if (e.target.matches('#logTopicFilter')) renderLogs(); });
        }

        setDefaultData();

        const stompClient = Stomp.over(new SockJS('/my-websocket'));
        stompClient.connect({}, frame => {
            fetchInitialLogs();
            stompClient.subscribe('/topic/logs', message => addLog(JSON.parse(message.body)));
        });

        // --- Helper Functions ---

        async function fetchAndRenderTable(topic, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            try {
                const response = await fetch(`/api/tspm/received-data?topic=${topic}`);
                if (!response.ok) throw new Error('网络响应错误');
                const data = await response.json();

                if (data.length === 0) {
                    container.innerHTML = '<div class="empty-data">暂无数据</div>';
                    return;
                }

                const headers = Object.keys(data[0]);
                let tableHtml = '<table><thead><tr>';
                headers.forEach(header => tableHtml += `<th>${header}</th>`);
                tableHtml += '</tr></thead><tbody>';

                data.forEach(row => {
                    tableHtml += '<tr>';
                    headers.forEach(header => {
                        const cellData = row[header] === null || row[header] === undefined ? '' : row[header];
                        tableHtml += `<td>${String(cellData).replace(/</g, '&lt;')}</td>`;
                    });
                    tableHtml += '</tr>';
                });

                tableHtml += '</tbody></table>';
                container.innerHTML = tableHtml;
                showToast(`刷新'${topic}'数据成功`, 'success');

            } catch (error) {
                container.innerHTML = `<div class="empty-data">加载数据失败: ${error.message}</div>`;
                showToast(`刷新'${topic}'数据失败`, 'error');
            }
        }
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('fade-out');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }
        function loadFromFile(targetTextarea) {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = event => { targetTextarea.value = event.target.result; };
                    reader.onerror = () => showToast('读取文件失败！', 'error');
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        function loadFromFile(targetTextarea) {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = event => { targetTextarea.value = event.target.result; };
                    reader.onerror = () => showToast('读取文件失败！', 'error');
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        function pushMessage(type, data) {
            fetch('/api/tspm/simulate/push', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type: type, data: data })
            }).then(response => {
                if (!response.ok) return response.text().then(text => { throw new Error(text) });
                return response.text();
            }).then(result => showToast('消息已提交推送'))
                .catch(error => showToast('推送失败: ' + error.message, 'error'));
        }

        async function generateJsonFromSql(type) {
            const sql = document.getElementById(`sql-${type}`).value.trim();
            const limit = document.getElementById(`limit-${type}`).value;
            const paramsStr = document.getElementById(`sql-params-${type}`).value;
            if (!sql) { showToast('SQL查询不能为空！', 'error'); return; }

            // Parse parameters, one per line
            const params = paramsStr.split('\n').map(p => p.trim()).filter(p => p !== '');

            try {
                const response = await fetch('/api/tspm/generate-json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sql: sql,
                        limit: parseInt(limit, 10) || 5,
                        params: params
                    })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                document.getElementById(`json-${type}`).value = JSON.stringify(await response.json(), null, 2);
                showToast('JSON生成成功');
            } catch (error) {
                showToast('从SQL生成JSON失败: ' + error.message, 'error');
            }
        }

        async function fetchInitialLogs() {
            try {
                const response = await fetch('/api/tspm/logs');
                if (response.ok) { allLogs = await response.json(); renderLogs(); }
            } catch (error) { console.error('获取初始日志失败:', error); }
        }
        function addLog(log) {
            allLogs.unshift(log);
            if (allLogs.length > maxLogs) allLogs.pop();
            renderLogs();
        }
        function renderLogs() {
            const logContainer = document.getElementById('logContainer');
            if(!logContainer) return;
            const topicFilter = document.getElementById('logTopicFilter').value;
            const textFilter = document.getElementById('logFilterInput').value.toLowerCase();
            const filteredLogs = allLogs.filter(log => (topicFilter === 'all' || log.topic === topicFilter) && (!textFilter || log.topic.toLowerCase().includes(textFilter) || log.content.toLowerCase().includes(textFilter)));
            logContainer.innerHTML = filteredLogs.map(log => `<div class="log-entry"><div><span class="log-timestamp">[${log.timestamp}]</span><span class="log-type-${log.type}">[${log.type}]</span><span class="log-topic">@ ${log.topic}</span></div><div class="log-content">${renderJsonAsPre(log.content)}</div></div>`).join('');
            if (document.getElementById('autoScroll').checked) logContainer.scrollTop = logContainer.scrollHeight;
        }
        function renderJsonAsPre(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                return `<pre>${JSON.stringify(data, null, 2).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>`;
            } catch (e) { return `<pre>${jsonString.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>`; }
        }

        function setDefaultData() {
            const defaultJson = {
                syncMaintenanceTask: JSON.stringify([{"planId":"P001","taskId":"T001","equipmentCode":"EQ-001","type":1,"project":"日保","content":"设备清洁与检查","standard":"按照设备手册标准操作","tool":"清洁工具、扳手","fullScore":10,"createDateTime":"2025-07-16 10:00:00","planStartTime":"2025-07-17 07:00:00","operator":"维修工","oilId":"OIL-001","oilQuantity":"适量"}], null, 2),
                syncRotationalPlan: JSON.stringify([{"planId":"20250716A","equipmentCode":"EQ-001","planDate":"2025-07-16","createDate":"2025-07-15"}], null, 2),
                syncRotationalTask: JSON.stringify([{"planId":"20250716A","taskId":"T001","equipmentCode":"EQ-001","project":"日常保养","content":"设备清洁与检查","standard":"按照设备手册标准操作","source":0,"fullScore":10,"createDateTime":"2025-07-16 08:00:00","operator":"维修工"}], null, 2),
                receiveFaultReportCode: JSON.stringify([{"type":0,"id":6,"code":"JB-E-20250716"}], null, 2),
                syncProductionHaltTask: JSON.stringify([{"taskId":"T001","equipmentCode":"EQ-001","content":"电机检查与更换","head":"张三","teamName":"班组A","executor":"李四","planStartTime":"2025-07-16 08:00:00","planEndTime":"2025-07-16 12:00:00"}], null, 2),
                syncUserEquipment: JSON.stringify([{"userCode":"7340","equipmentCode":"EQ-001","shiftStartTime":"2025-08-18 07:00:00","shiftId":1,"shiftName":"白班","type":0}, {"userCode":"7340","equipmentCode":"EQ-002","shiftStartTime":"2025-08-18 15:00:00","shiftId":2,"shiftName":"中班","type":0}], null, 2)
            };
            const defaultSql = {
                syncMaintenanceTask: `select b.indocno as "planId", 'taskId'||to_char(sysdate,'yyyyMMddmmss')||b.idtno as "taskId", b.spmcode as "equipmentCode", 1 AS "type", b.stitle as "project", b.sdetail as "content", b.sstandard as "standard", '' as "tool", b.ibasevalue as "fullScore", to_char(sysdate,'yyyy-MM-dd hh24:mi') as "createDateTime", to_char(sysdate,'yyyy-MM-dd hh24:mi') as "planStartTime", d.name as "operator", '' AS "oilId", '' AS "oilQuantity" from maintainbook a, maintainbookdt b, EQTREEOPT c, users d where a.indocno=b.ilinkno and b.spmcode=? and b.ilinkno=a.indocno and c.sfcode=b.sfcode and d.id=c.iuser`,
                syncRotationalPlan: `SELECT '20250716A' AS "planId", 'EQ-001' AS "equipmentCode", '2025-07-16' AS "planDate", '2025-07-15' AS "createDate" FROM DUAL`,
                syncRotationalTask: `SELECT '20250716A' AS "planId", 'T001' AS "taskId", 'EQ-001' AS "equipmentCode", '日常保养' AS "project", '设备清洁与检查' AS "content", '按照设备手册标准操作' AS "standard", 0 AS "source", 10 AS "fullScore", '2025-07-16 08:00:00' AS "createDateTime", '维修工' AS "operator" FROM DUAL`,
                receiveFaultReportCode: `SELECT 0 AS "type", 6 AS "id", 'JB-E-20250716' AS "code" FROM DUAL`,
                syncProductionHaltTask: `SELECT 'T001' AS "taskId", 'EQ-001' AS "equipmentCode", '电机检查与更换' AS "content", '张三' AS "head", '班组A' AS "teamName", '李四' AS "executor", '2025-07-16 08:00:00' AS "planStartTime", '2025-07-16 12:00:00' AS "planEndTime" FROM DUAL`,
                syncUserEquipment: `select a.sjzspmcode,a.sjzname,c.iuser as "userCode",d.loginid,d.name,d.NGWNAME,(select svalue from fieldvalue where id=d.IBZ) as "teamName" from EQGYD a, EQGYD_DT b, EQTREEOPT c, users d where a.indocno=b.ilinkno and a.sjzname like ? and b.ilinkno=a.indocno and c.sfcode=b.sfcode and d.id=c.iuser`
            };
            const defaultParams = {
                syncMaintenanceTask: "JB000484",
                syncUserEquipment: "%GDGY 46#ZB48A%"
            }

            for (const key in defaultJson) { if (document.getElementById(`json-${key}`)) { document.getElementById(`json-${key}`).value = defaultJson[key]; } }
            for (const key in defaultSql) { if (document.getElementById(`sql-${key}`)) { document.getElementById(`sql-${key}`).value = defaultSql[key]; } }
            for (const key in defaultParams) { if (document.getElementById(`sql-params-${key}`)) { document.getElementById(`sql-params-${key}`).value = defaultParams[key]; } }
        }

        // --- Functions from previous versions, kept for brevity ---
        async function fetchAndRenderTable(topic, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            try {
                const response = await fetch(`/api/tspm/received-data?topic=${topic}`);
                if (!response.ok) throw new Error('网络响应错误');
                const data = await response.json();
                if (data.length === 0) { container.innerHTML = '<div class="empty-data">暂无数据</div>'; return; }
                const headers = Object.keys(data[0]);
                let tableHtml = '<table><thead><tr>';
                headers.forEach(header => tableHtml += `<th>${header}</th>`);
                tableHtml += '</tr></thead><tbody>';
                data.forEach(row => {
                    tableHtml += '<tr>';
                    headers.forEach(header => {
                        const cellData = row[header] === null || row[header] === undefined ? '' : row[header];
                        tableHtml += `<td>${String(cellData).replace(/</g, '&lt;')}</td>`;
                    });
                    tableHtml += '</tr>';
                });
                tableHtml += '</tbody></table>';
                container.innerHTML = tableHtml;
                showToast(`刷新'${topic}'数据成功`, 'success');
            } catch (error) {
                container.innerHTML = `<div class="empty-data">加载数据失败: ${error.message}</div>`;
                showToast(`刷新'${topic}'数据失败`, 'error');
            }
        }
        function addLog(log) { allLogs.unshift(log); if (allLogs.length > maxLogs) allLogs.pop(); renderLogs(); }
        function renderLogs() {
            const logContainer = document.getElementById('logContainer');
            if(!logContainer) return;
            const topicFilter = document.getElementById('logTopicFilter').value;
            const textFilter = document.getElementById('logFilterInput').value.toLowerCase();
            const filteredLogs = allLogs.filter(log => (topicFilter === 'all' || log.topic === topicFilter) && (!textFilter || log.topic.toLowerCase().includes(textFilter) || log.content.toLowerCase().includes(textFilter)));
            logContainer.innerHTML = filteredLogs.map(log => `<div class="log-entry"><div><span class="log-timestamp">[${log.timestamp}]</span><span class="log-type-${log.type}">[${log.type}]</span><span class="log-topic">@ ${log.topic}</span></div><div class="log-content">${renderJsonAsPre(log.content)}</div></div>`).join('');
            if (document.getElementById('autoScroll').checked) logContainer.scrollTop = logContainer.scrollHeight;
        }
        function renderJsonAsPre(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                return `<pre>${JSON.stringify(data, null, 2).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>`;
            } catch (e) { return `<pre>${jsonString.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>`; }
        }
    });
</script>

</body>
</html>

