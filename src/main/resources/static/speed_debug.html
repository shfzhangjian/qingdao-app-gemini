<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>车速接口调试工具</title>
    <link href="libs/bootstrap-5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="libs/bootstrap-icons-1.11.3/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; padding: 30px; }
        .card { border: none; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); }
        .status-box { background: #212529; color: #00ff00; padding: 15px; border-radius: 5px; font-family: monospace; height: 300px; overflow-y: auto; }
        /* [新增] 表格样式 */
        .table-responsive { max-height: 400px; overflow-y: auto; }
        th { position: sticky; top: 0; background-color: #e9ecef; }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-4">
        <h2 class="fw-bold text-primary"><i class="bi bi-speedometer"></i> 设备车速接口调试</h2>
        <p class="text-muted">批量调用 TIMS 接口获取所有自检设备的实时车速并更新到本地数据库。</p>
    </div>

    <div class="card mb-4">
        <div class="card-body text-center p-5">
            <div class="d-grid gap-3 d-md-flex justify-content-md-center">
                <button id="btn-refresh" class="btn btn-lg btn-primary px-5">
                    <i class="bi bi-cloud-download-fill me-2"></i> 一键刷新所有设备车速
                </button>
                <button id="btn-view-list" class="btn btn-lg btn-outline-secondary px-5">
                    <i class="bi bi-list-ul me-2"></i> 查看最近记录
                </button>
            </div>
            <p class="mt-3 text-secondary small">注意：刷新操作将遍历所有台账记录，耗时较长，请勿频繁点击。</p>
        </div>
    </div>

    <!-- [新增] 记录列表展示区域 (默认隐藏) -->
    <div class="card mb-4 d-none" id="record-card">
        <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
            <span><i class="bi bi-table"></i> 最近更新记录 (前100条)</span>
            <button class="btn btn-sm btn-close" onclick="document.getElementById('record-card').classList.add('d-none')"></button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 text-center align-middle">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>批次号</th>
                        <th>设备编码 (SPMCODE)</th>
                        <th>平均车速</th>
                        <th>开始时间</th>
                        <th>结束时间</th>
                    </tr>
                    </thead>
                    <tbody id="record-tbody">
                    <!-- 数据将由 JS 填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-white fw-bold">
            <i class="bi bi-terminal"></i> 执行日志
        </div>
        <div class="card-body bg-dark p-0">
            <div id="log-box" class="status-box">
                <div>[System] 等待操作...</div>
            </div>
        </div>
    </div>
</div>

<script src="libs/bootstrap-5.3.3/js/bootstrap.bundle.min.js"></script>
<script>
    const btnRefresh = document.getElementById('btn-refresh');
    const btnViewList = document.getElementById('btn-view-list');
    const logBox = document.getElementById('log-box');
    const recordCard = document.getElementById('record-card');
    const recordTbody = document.getElementById('record-tbody');

    function log(msg, type = 'info') {
        const time = new Date().toLocaleTimeString();
        let color = '#00ff00';
        if (type === 'error') color = '#ff4444';
        if (type === 'warn') color = '#ffbb33';

        const div = document.createElement('div');
        div.innerHTML = `<span style="color:#888">[${time}]</span> <span style="color:${color}">${msg}</span>`;
        logBox.appendChild(div);
        logBox.scrollTop = logBox.scrollHeight;
    }

    // 获取 Token
    function getHeaders() {
        const token = localStorage.getItem('jwt_token');
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;
        return headers;
    }

    // 格式化日期
    function formatDate(isoStr) {
        if (!isoStr) return '-';
        return new Date(isoStr).toLocaleString();
    }

    btnRefresh.addEventListener('click', async () => {
        if (!confirm('确定要开始全量刷新吗？这可能需要几分钟时间。')) return;

        btnRefresh.disabled = true;
        btnRefresh.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 请求已发送...';
        log('正在发送批量刷新请求...', 'warn');

        try {
            const response = await fetch('/tmis/api/si/speed/refresh-all', {
                method: 'POST',
                headers: getHeaders()
            });

            if (response.ok) {
                const res = await response.json();
                log(`Success: ${res.message}`);
                log('任务已在后台运行。您可以稍后点击“查看最近记录”验证结果。');
            } else {
                const err = await response.text();
                log(`Error: ${err}`, 'error');
            }
        } catch (e) {
            log(`Network Error: ${e.message}`, 'error');
        } finally {
            setTimeout(() => {
                btnRefresh.disabled = false;
                btnRefresh.innerHTML = '<i class="bi bi-cloud-download-fill me-2"></i> 一键刷新所有设备车速';
            }, 2000);
        }
    });

    btnViewList.addEventListener('click', async () => {
        btnViewList.disabled = true;
        btnViewList.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 加载中...';

        try {
            const response = await fetch('/tmis/api/si/speed/list', {
                method: 'GET',
                headers: getHeaders()
            });

            if (response.ok) {
                const list = await response.json();
                recordTbody.innerHTML = '';

                if (list.length === 0) {
                    recordTbody.innerHTML = '<tr><td colspan="6" class="text-muted">暂无记录</td></tr>';
                } else {
                    list.forEach(item => {
                        // 注意：MyBatis返回的Map key可能是大写
                        const id = item.INDOCNO || item.indocno;
                        const batch = item.BATCH_NO || item.batchNo;
                        const code = item.SPMCODE || item.spmcode;
                        const speed = item.AVG_SPEED || item.avgSpeed;
                        const start = item.START_TIME || item.startTime;
                        const end = item.END_TIME || item.endTime;

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${id}</td>
                            <td><span class="badge bg-secondary">${batch}</span></td>
                            <td class="fw-bold text-primary">${code}</td>
                            <td class="fs-5">${speed}</td>
                            <td>${formatDate(start)}</td>
                            <td>${formatDate(end)}</td>
                        `;
                        recordTbody.appendChild(tr);
                    });
                }
                recordCard.classList.remove('d-none');
                log(`成功加载 ${list.length} 条记录。`);
            } else {
                log(`加载列表失败: ${response.status}`, 'error');
            }
        } catch (e) {
            log(`Network Error: ${e.message}`, 'error');
        } finally {
            btnViewList.disabled = false;
            btnViewList.innerHTML = '<i class="bi bi-list-ul me-2"></i> 查看最近记录';
        }
    });
</script>
</body>
</html>